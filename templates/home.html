<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yalopido</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f4f7f6; padding-top: 60px; padding-bottom: 70px; }
        .top-bar { position: fixed; top: 0; left: 0; right: 0; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 1000; padding: 8px 16px; }
        #search-input { width: 100%; padding: 10px 15px; border-radius: 20px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; }

        main { padding: 0 16px; }
        .section { margin-bottom: 24px; }
        .section h2 { font-size: 18px; font-weight: bold; margin: 0 0 12px; color: #333; }
        
        .horizontal-scroll { display: flex; overflow-x: auto; scroll-behavior: smooth; gap: 16px; padding: 4px; scrollbar-width: none; -ms-overflow-style: none; min-height: 180px; align-items: center; }
        .horizontal-scroll::-webkit-scrollbar { display: none; }

        .category-card { flex: 0 0 auto; padding: 12px 20px; border-radius: 20px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.06); text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .category-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .category-card p { margin: 0; font-weight: 500; }

        .product-card, .offer-card { display: flex; flex-direction: column; background-color: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; cursor: pointer; text-align: left; transition: transform 0.2s, box-shadow 0.2s; }
        .product-card:hover, .offer-card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.12); }
        
        .img-container { width: 100%; height: 140px; display: flex; align-items: center; justify-content: center; background-color: #fff; padding: 8px; box-sizing: border-box; }
        .product-card img, .offer-card img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        .info { padding: 12px; flex-grow: 1; border-top: 1px solid #f0f0f0; }
        .name { font-weight: 600; margin: 0 0 4px; overflow: hidden; text-overflow: ellipsis; font-size: 14px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; min-height: 34px; }
        .price { font-size: 16px; color: #00897b; font-weight: bold; }
        .offer-card .price-container { display: flex; align-items: baseline; gap: 8px; }
        .offer-card .price-original { text-decoration: line-through; color: #999; font-size: 12px; }
        .offer-card .price-final { color: #E5356F; font-size: 16px; font-weight: bold; }

        #offers-container .offer-card { flex: 0 0 auto; width: 240px; }
        #recommendations-container .product-card { flex: 0 0 auto; width: 180px; }

        .product-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; min-height: 200px; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around; background-color: #fff; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); z-index: 1000; padding: 8px 0; }
        .bottom-nav a { flex: 1; text-align: center; color: #888; text-decoration: none; padding: 4px 0; }
        .bottom-nav a.active { color: #00897b; }
        .bottom-nav i { font-size: 22px; }
        .bottom-nav p { font-size: 12px; margin: 4px 0 0; }
        
        .spinner-container { display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #00897b; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .empty-state { text-align: center; padding: 20px; color: #888; width: 100%; }

    </style>
</head>
<body>

    <header class="top-bar"><input type="search" id="search-input" placeholder="Buscar productos y ofertas..."></header>

    <main id="main-content">
        <section id="category-section" class="section"><div id="category-scroll" class="horizontal-scroll"></div></section>
        <section id="offers-section" class="section"><h2>Ofertas</h2><div id="offers-container" class="horizontal-scroll"></div></section>
        <section id="recommendations-section" class="section"><h2>Recomendado para ti</h2><div id="recommendations-container" class="horizontal-scroll"></div></section>
        <section id="products-section" class="section"><h2>Todos los Productos</h2><div id="product-grid" class="product-grid"></div></section>
    </main>

    <footer class="bottom-nav">
        <a href="home.html" class="active"><i class="fas fa-home"></i><p>Inicio</p></a>
        <a href="cart.html" id="cart-button"><i class="fas fa-shopping-cart"></i><p>Carrito</p></a>
        <a href="mi-cuenta.html"><i class="fas fa-user"></i><p>Cuenta</p></a>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDHZzoPhzUPX-6BWaCx4J5xeXwSeOYmkMY", authDomain: "taxinet-929d8.firebaseapp.com", projectId: "taxinet-929d8", storageBucket: "taxinet-929d8.appspot.com", messagingSenderId: "52566606294", appId: "1:52566606294:web:6a2b4f1e7c964502c46477" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let allProducts = [];
        let allOffers = [];

        const getEl = (id) => document.getElementById(id);
        const mainContent = getEl('main-content');
        const categoryScroll = getEl('category-scroll');
        const offersContainer = getEl('offers-container');
        const recommendationsContainer = getEl('recommendations-container');
        const productGrid = getEl('product-grid');
        const searchInput = getEl('search-input');

        const spinner = '<div class="spinner-container"><div class="spinner"></div></div>';

        auth.onAuthStateChanged(user => user ? loadAllData(user.uid) : window.location.href = 'app.html');

        async function loadAllData(uid) {
            displayCategories();
            startCategoryAutoScroll();
            
            offersContainer.innerHTML = spinner;
            recommendationsContainer.innerHTML = spinner;
            productGrid.innerHTML = spinner;

            await Promise.all([fetchProducts(), fetchOffers(), fetchRecommendations(uid)]);
        }

        function displayCategories() {
            const categories = ["Alcohol", "Bebidas", "Comida", "Farmacia", "Comida Rápida", "Snacks"];
            categoryScroll.innerHTML = categories.map(cat => `<div class="category-card" data-category="${cat}"><p>${cat}</p></div>`).join('');
        }
        
        function startCategoryAutoScroll() {
            setInterval(() => {
                const maxScroll = categoryScroll.scrollWidth - categoryScroll.clientWidth;
                categoryScroll.scrollLeft >= maxScroll - 1 ? categoryScroll.scrollLeft = 0 : categoryScroll.scrollLeft += 120;
            }, 3000);
        }

        async function fetchProducts() {
            try {
                const snapshot = await db.collection("products").get();
                allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts(allProducts);
            } catch (e) { productGrid.innerHTML = '<p class="empty-state">Error al cargar productos.</p>'; }
        }

        async function fetchOffers() {
            try {
                const snapshot = await db.collection("products").where("isOffer", "==", true).get();
                allOffers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderOffers(allOffers);
            } catch (e) { offersContainer.innerHTML = '<p class="empty-state">Error al cargar ofertas.</p>'; }
        }
        
        async function fetchRecommendations(uid) {
            try {
                const ordersSnap = await db.collection("pedidos").where("compradorUID", "==", uid).limit(10).get();
                if (ordersSnap.empty) {
                    renderRecommendations([]); return;
                }

                const catCounts = new Map();
                const prodPromises = ordersSnap.docs.map(doc => doc.ref.collection("productos").get());
                const prodSnaps = await Promise.all(prodPromises);
                
                prodSnaps.forEach(snap => snap.forEach(prodDoc => {
                    const cat = prodDoc.data().category;
                    if(cat) catCounts.set(cat, (catCounts.get(cat) || 0) + 1);
                }));

                if (catCounts.size === 0) { renderRecommendations([]); return; }
                
                const topCats = [...catCounts.entries()].sort((a,b) => b[1]-a[1]).slice(0,3).map(e=>e[0]);
                if(topCats.length === 0) { renderRecommendations([]); return; }

                const recosSnap = await db.collection("products").where("category", "in", topCats).limit(10).get();
                const recoProds = recosSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(p => !p.isOffer && !allOffers.some(o => o.id === p.id));
                renderRecommendations(recoProds);
            } catch (e) { console.error(e); recommendationsContainer.innerHTML = '<p class="empty-state">Error al cargar recomendaciones.</p>'; }
        }

        function renderProducts(products) {
            if (products.length === 0) {
                productGrid.innerHTML = '<p class="empty-state">No se encontraron productos.</p>';
                return;
            }
            productGrid.innerHTML = products.map(p => createProductCard(p)).join('');
        }

        function renderOffers(offers) {
            if (offers.length === 0) {
                offersContainer.innerHTML = '<p class="empty-state">No hay ofertas por el momento.</p>';
                return;
            }
            offersContainer.innerHTML = offers.map(o => createOfferCard(o)).join('');
        }
        
        function renderRecommendations(products) {
            if (products.length === 0) {
                recommendationsContainer.innerHTML = '<p class="empty-state">Compra más para ver recomendaciones.</p>';
                return;
            }
            recommendationsContainer.innerHTML = products.map(p => createProductCard(p)).join('');
        }

        function createProductCard(p) {
            return `
                <div class="product-card" data-id="${p.id}">
                    <div class="img-container"><img src="${p.imageUrl || 'https://via.placeholder.com/150'}" alt="${p.name}"></div>
                    <div class="info">
                        <p class="name">${p.name}</p>
                        <p class="price">S/ ${p.price.toFixed(2)}</p>
                    </div>
                </div>`;
        }
        
        function createOfferCard(p) {
            return `
                <div class="offer-card" data-id="${p.id}">
                     <div class="img-container"><img src="${p.imageUrl || 'https://via.placeholder.com/220'}" alt="${p.name}"></div>
                    <div class="info">
                        <p class="name">${p.name}</p>
                        <div class="price-container">
                            <span class="price-original">S/ ${p.price.toFixed(2)}</span>
                            <span class="price-final">S/ ${p.offerPrice.toFixed(2)}</span>
                        </div>
                    </div>
                </div>`;
        }
        
        searchInput.addEventListener('input', e => {
            const query = e.target.value.toLowerCase();
            renderProducts(allProducts.filter(p => p.name.toLowerCase().includes(query)));
        });

        mainContent.addEventListener('click', (e) => {
            const card = e.target.closest('.product-card, .offer-card, .category-card');
            if (!card) return;

            const productId = card.dataset.id;
            const category = card.dataset.category;

            if (productId) {
                window.location.href = `ver-producto.html?id=${productId}`;
            } else if (category) {
                // Handle category click later if needed
                console.log("Category clicked:", category);
            }
        });

    </script>
</body>
</html>