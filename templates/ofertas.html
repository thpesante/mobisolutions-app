<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Ofertas - Yalopido</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f4f7f6; display: flex; color: #333; }
        .sidebar { width: 260px; background-color: #ffffff; height: 100vh; position: fixed; left: 0; top: 0; box-shadow: 2px 0 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; z-index: 1001; transition: transform 0.3s ease-in-out; }
        .sidebar.open { transform: translateX(0); }
        .sidebar-header { padding: 20px; background-color: #00897b; color: white; text-align: center; }
        .sidebar-header .logo { font-weight: bold; font-size: 24px; margin-bottom: 10px; }
        .sidebar-nav { list-style: none; padding: 0; margin: 20px 0; flex-grow: 1; }
        .sidebar-nav li { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; font-size: 16px; color: #555; transition: background-color 0.2s, color 0.2s; }
        .sidebar-nav li i { margin-right: 15px; width: 20px; text-align: center; }
        .sidebar-nav li:hover, .sidebar-nav li.active { background-color: #e0e0e0; }
        .sidebar-footer { padding: 20px; text-align: center; }
        #logout-btn { background: none; border: 1px solid #E5356F; color: #E5356F; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%; }

        .main-content { margin-left: 260px; padding: 30px; width: calc(100% - 260px); transition: margin-left 0.3s ease-in-out; }
        .main-header { display: none; align-items: center; justify-content: space-between; gap: 20px; margin-bottom: 20px; }
        .menu-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #333; }
        .container { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 25px; }
        .container h1, .container h2 { margin-top: 0; color: #00897b; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        h1.desktop-only { margin-bottom: 25px; }

        #product-selection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 20px; }
        .product-item { border: 1px solid #ddd; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; position: relative; }
        .product-item.selected { border-color: #00897b; background-color: #e8f3f2; }
        .product-item img { width: 100%; height: 80px; object-fit: cover; margin-bottom: 5px; border-radius: 4px; }
        .offer-creation-form { display: flex; gap: 20px; align-items: flex-end; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        #create-offer-btn { background-color: #E5356F; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        
        #suggestions-container, #active-offers-container { display: grid; gap: 20px; }
        #suggestions-container { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
        #active-offers-container { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }

        .suggestion-card, .offer-card { background-color: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: hidden; position: relative; text-align: left; transition: box-shadow 0.2s; }
        .suggestion-card:hover, .offer-card:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        
        .suggestion-card img { width: 100%; height: 120px; object-fit: cover; }
        .suggestion-card .product-name { padding: 10px; font-weight: bold; }
        .suggestion-card .quick-offer-btn { background-color: #00897b; color: white; border: none; padding: 8px 12px; margin: 0 10px 10px; border-radius: 4px; cursor: pointer; width: calc(100% - 20px); }

        .offer-card img { width: 100%; height: 160px; object-fit: cover; }
        .offer-card h3 { margin: 10px 15px 5px; font-size: 1.1em; }
        .price-container { display: flex; align-items: baseline; gap: 10px; padding: 0 15px 10px; }
        .price-original { text-decoration: line-through; color: #888; }
        .price-final { color: #E5356F; font-weight: bold; font-size: 1.25em; }
        .discount-badge { position: absolute; top: 10px; left: 10px; background-color: #E5356F; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .delete-offer-btn { position: absolute; top: 10px; right: 10px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; color: #E5356F; font-size: 16px; line-height: 32px; text-align: center; }

        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; }
        .sidebar-overlay.open { display: block; }

        @media (max-width: 992px) { #active-offers-container { grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); } }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .main-content { margin-left: 0; width: 100%; padding: 15px; }
            .main-header { display: flex; }
            h1.desktop-only { display: none; }
            .offer-creation-form { flex-direction: column; align-items: stretch; gap: 10px; }
            #product-selection-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
            #suggestions-container, #active-offers-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <aside class="sidebar" id="sidebar"> 
    <div class="sidebar-header"><div class="logo">Yalopido</div><div class="user-info"><p id="user-email"></p></div></div>
    <ul class="sidebar-nav">
        <li onclick="navigateTo('pedidos.html')"><i class="fas fa-receipt"></i> Pedidos</li>
        <li class="active" onclick="navigateTo('ofertas.html')"><i class="fas fa-tags"></i> Ofertas</li>
        <li onclick="navigateTo('productos.html')"><i class="fas fa-box-open"></i> Productos</li>
        <li onclick="navigateTo('producto-destacado.html')"><i class="fas fa-star"></i> Producto destacado</li>
        <li onclick="navigateTo('reportes.html')"><i class="fas fa-chart-line"></i> Reportes</li>
        <li onclick="navigateTo('cuenta.html')"><i class="fas fa-user-shield"></i> Cuenta</li>
    </ul>
        <div class="sidebar-footer"><button id="logout-btn">Cerrar Sesión</button></div>
    </aside>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <main class="main-content">
        <header class="main-header"><button class="menu-btn" id="menu-btn"><i class="fas fa-bars"></i></button><h2>Gestión de Ofertas</h2></header>
        <h1 class="desktop-only">Gestión de Ofertas</h1>
        <div class="container">
            <h2>Sugerencias Inteligentes</h2>
            <div id="suggestions-container"><p>Cargando sugerencias...</p></div>
        </div>
        <div class="container">
            <h2>Crear Nueva Oferta</h2>
            <div id="product-selection-grid"><p>Cargando todos los productos...</p></div>
            <div class="offer-creation-form">
                <div style="flex-grow: 1;"><label for="discount-percentage">Descuento (%)</label><input type="number" id="discount-percentage" min="1" max="99" placeholder="Ej: 15" class="form-group"></div>
                <button id="create-offer-btn">Aplicar Oferta</button>
            </div>
        </div>
        <div class="container"><h2>Ofertas Activas</h2><div id="active-offers-container"><p>Cargando...</p></div></div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script>
        function navigateTo(path) { window.location.href = path; }
        const firebaseConfig = { apiKey: "AIzaSyDHZzoPhzUPX-6BWaCx4J5xeXwSeOYmkMY", authDomain: "taxinet-929d8.firebaseapp.com", projectId: "taxinet-929d8", storageBucket: "taxinet-929d8.appspot.com", messagingSenderId: "52566606294", appId: "1:52566606294:web:6a2b4f1e7c964502c46477" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        let currentUser = null;

        const userEmailSpan = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const productGrid = document.getElementById('product-selection-grid');
        const activeOffersContainer = document.getElementById('active-offers-container');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const createOfferBtn = document.getElementById('create-offer-btn');
        const discountInput = document.getElementById('discount-percentage');

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                userEmailSpan.textContent = user.email;
                await Promise.all([ loadProductsForSelection(), loadActiveOffers(), loadOfferSuggestions() ]);
            } else { window.location.href = 'app.html'; }
        });

        async function getAuthToken() {
            if (!currentUser) throw new Error("Usuario no autenticado.");
            return await currentUser.getIdToken(true);
        }

        async function apiFetch(endpoint, options = {}) {
            const token = await getAuthToken();
            const response = await fetch(endpoint, { ...options, headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token, ...options.headers } });
            
            const contentType = response.headers.get("content-type");
            if (response.ok && contentType && contentType.indexOf("application/json") !== -1) {
                return response.json();
            } 

            // If response is not OK or not JSON, get the text and throw an error.
            const errorText = await response.text();
            console.error(`Error fetching ${endpoint}. Status: ${response.status}. Response:`, errorText);
            throw new Error(`Error del servidor al contactar ${endpoint}.`);
        }

        async function loadProductsForSelection() {
             try {
                const products = await apiFetch('/api/get_all_products');
                productGrid.innerHTML = '';
                const productsWithoutOffer = products.filter(p => !p.isOffer);
                if (productsWithoutOffer.length === 0) {
                    productGrid.innerHTML = '<p>No hay productos disponibles para crear nuevas ofertas.</p>';
                    return;
                }
                productsWithoutOffer.forEach(product => {
                    const item = document.createElement('div');
                    item.className = 'product-item';
                    item.dataset.productId = product.id;
                    item.innerHTML = `<input type="checkbox" class="checkbox" data-product-id="${product.id}" style="display: none;"><img src="${product.imageUrl || 'https://via.placeholder.com/150'}" alt="${product.name}"><div class="product-name">${product.name}</div>`;
                    item.addEventListener('click', () => toggleProductSelection(product.id));
                    productGrid.appendChild(item);
                });
            } catch (error) { 
                console.error('Error cargando productos:', error);
                productGrid.innerHTML = `<p>Error al cargar productos. Revise la consola para más detalles.</p>`;
            }
        }
        
        function toggleProductSelection(productId, forceState = null) {
            const item = productGrid.querySelector(`.product-item[data-product-id='${productId}']`);
            if (!item) return;
            const checkbox = item.querySelector('.checkbox');
            const newState = forceState !== null ? forceState : !checkbox.checked;
            checkbox.checked = newState;
            item.classList.toggle('selected', newState);
        }

        async function loadActiveOffers() {
            try {
                const offers = await apiFetch('/api/get_offers');
                activeOffersContainer.innerHTML = '';
                if (offers.length === 0) {
                    activeOffersContainer.innerHTML = '<p>No hay ofertas activas en este momento.</p>';
                    return;
                }
                offers.forEach(offer => {
                    const card = document.createElement('div');
                    card.className = 'offer-card';
                    card.innerHTML = `<img src="${offer.imageUrl || 'https://via.placeholder.com/280'}" alt="${offer.name}"><h3>${offer.name}</h3><div class="price-container"><span class="price-original">S/ ${parseFloat(offer.price || 0).toFixed(2)}</span><span class="price-final">S/ ${parseFloat(offer.offerPrice || 0).toFixed(2)}</span></div><div class="discount-badge">-${offer.discountPercentage}%</div><button class="delete-offer-btn" data-product-id="${offer.id}" title="Eliminar Oferta"><i class="fas fa-trash-alt"></i></button>`;
                    card.querySelector('.delete-offer-btn').addEventListener('click', () => removeOffer(offer.id));
                    activeOffersContainer.appendChild(card);
                });
            } catch (error) { 
                console.error('Error cargando ofertas activas:', error);
                activeOffersContainer.innerHTML = `<p>Error al cargar ofertas. Revise la consola para más detalles.</p>`;
            }
        }

        async function loadOfferSuggestions() {
            try {
                const suggestions = await apiFetch('/api/offer_suggestions');
                suggestionsContainer.innerHTML = '';
                if (suggestions.length === 0) {
                    suggestionsContainer.innerHTML = '<p>¡Buen trabajo! Todos tus productos se han vendido al menos una vez.</p>';
                    return;
                }
                suggestions.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'suggestion-card';
                    card.innerHTML = `<img src="${product.imageUrl || 'https://via.placeholder.com/200'}" alt="${product.name}"><div class="product-name">${product.name}</div><button class="quick-offer-btn" data-product-id="${product.id}">Crear Oferta Rápida</button>`;
                    card.querySelector('.quick-offer-btn').addEventListener('click', () => { 
                        document.querySelectorAll('.product-item.selected').forEach(item => toggleProductSelection(item.dataset.productId, false));
                        toggleProductSelection(product.id, true);
                        discountInput.focus();
                        discountInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    });
                    suggestionsContainer.appendChild(card);
                });
            } catch (error) { 
                console.error('Error cargando sugerencias:', error);
                suggestionsContainer.innerHTML = `<p>No se pudieron cargar las sugerencias. Revise la consola para más detalles.</p>`;
            }
        }

        createOfferBtn.addEventListener('click', async () => {
            const productIds = Array.from(productGrid.querySelectorAll('.checkbox:checked')).map(cb => cb.dataset.productId);
            const discountPercentage = parseInt(discountInput.value);
            if (productIds.length === 0) return alert('Por favor, selecciona al menos un producto.');
            if (isNaN(discountPercentage) || discountPercentage < 1 || discountPercentage > 99) return alert('Introduce un descuento válido (1-99).');
            try {
                await apiFetch('/api/create_offers', { method: 'POST', body: JSON.stringify({ productIds, discountPercentage }) });
                alert('¡Ofertas creadas con éxito!');
                discountInput.value = '';
                await Promise.all([ loadProductsForSelection(), loadActiveOffers(), loadOfferSuggestions() ]);
            } catch (error) { alert(`Error al crear las ofertas: ${error.message}`); }
        });

        async function removeOffer(productId) {
            if (!confirm('¿Seguro que quieres eliminar esta oferta?')) return;
            try {
                await apiFetch('/api/remove_offer', { method: 'POST', body: JSON.stringify({ productId }) });
                alert('Oferta eliminada con éxito.');
                await Promise.all([ loadProductsForSelection(), loadActiveOffers(), loadOfferSuggestions() ]);
            } catch (error) { alert(`Error al eliminar la oferta: ${error.message}`); }
        }

        logoutBtn.addEventListener('click', () => auth.signOut().then(() => { window.location.href = 'app.html'; }));

        const menuBtn = document.getElementById('menu-btn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        menuBtn.addEventListener('click', () => { sidebar.classList.toggle('open'); overlay.classList.toggle('open'); });
        overlay.addEventListener('click', () => { sidebar.classList.remove('open'); overlay.classList.remove('open'); });
    </script>
</body>
</html>